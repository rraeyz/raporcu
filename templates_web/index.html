{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Deney Raporunuzu Oluşturun</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Metinsel bir dosya yükleyin veya ses dosyası yükleyerek transkripsiyon yapın, yapay zeka ile raporunuzu oluşturun.
                </div>

                <!-- Dosya Yükleme Formu -->
                <form id="upload-form" class="mb-4">
                    <div class="mb-3">
                        <label for="file-upload" class="form-label">Dosya Seçin</label>
                        <input type="file" class="form-control" id="file-upload" name="file">
                        <div class="form-text">Desteklenen formatlar: TXT, PDF, DOCX, MP3, WAV, MP4</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ai-model" class="form-label">AI Modeli</label>
                            <select class="form-select" id="ai-model" name="ai_model">
                                {% for model in ai_models %}
                                <option value="{{ model }}" {% if model == active_model %}selected{% endif %}>{{ model }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="template" class="form-label">Şablon</label>
                            <select class="form-select" id="template" name="template_id">
                                {% for id, name in templates.items() %}
                                <option value="{{ id }}" {% if id == active_template %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-2"></i>Yükle ve İşle
                    </button>
                </form>

                <!-- İşlem Durumu -->
                <div id="process-status" class="d-none">
                    <div class="alert alert-warning">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-warning me-3" role="status">
                                <span class="visually-hidden">İşleniyor...</span>
                            </div>
                            <div>
                                <h5 class="mb-1">Dosyanız İşleniyor</h5>
                                <p class="mb-0">Bu işlem, dosya boyutuna bağlı olarak biraz zaman alabilir.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dosya Listesi -->
                <div id="file-list" class="mt-4 d-none">
                    <h4>Dosyalarınız</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Dosya Adı</th>
                                    <th>Tür</th>
                                    <th>Yükleme Zamanı</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="file-list-body">
                                <!-- AJAX ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sonuç -->
                <div id="result-section" class="mt-4 d-none">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Rapor Başarıyla Oluşturuldu</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Raporunuz başarıyla oluşturuldu. Aşağıdaki butonlardan indirebilir veya önizleme yapabilirsiniz.</p>
                            <div id="result-buttons" class="d-flex gap-2">
                                <!-- AJAX ile doldurulacak -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hata Mesajı -->
                <div id="error-section" class="mt-4 d-none">
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">Hata!</h5>
                        <p id="error-message"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const uploadForm = $('#upload-form');
        const processStatus = $('#process-status');
        const fileList = $('#file-list');
        const fileListBody = $('#file-list-body');
        const resultSection = $('#result-section');
        const resultButtons = $('#result-buttons');
        const errorSection = $('#error-section');
        const errorMessage = $('#error-message');
        
        // Form gönderimi
        uploadForm.on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const fileInput = $('#file-upload')[0];
            
            if (fileInput.files.length === 0) {
                showError('Lütfen bir dosya seçin.');
                return;
            }
            
            // İşlem durumu göster
            processStatus.removeClass('d-none');
            errorSection.addClass('d-none');
            
            // Dosyayı yükle
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    processFile(response.filename);
                },
                error: function(xhr) {
                    processStatus.addClass('d-none');
                    const response = xhr.responseJSON || {};
                    showError(response.error || 'Dosya yükleme sırasında bir hata oluştu.');
                }
            });
        });
        
        // Dosyayı işle
        function processFile(filename) {
            const formData = new FormData();
            formData.append('file_index', fileListBody.children().length);
            formData.append('ai_model', $('#ai-model').val());
            formData.append('template_id', $('#template').val());
            
            $.ajax({
                url: '/process',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    processStatus.addClass('d-none');
                    updateFileList();
                    showResult(response.file_index, response.filename);
                },
                error: function(xhr) {
                    processStatus.addClass('d-none');
                    const response = xhr.responseJSON || {};
                    showError(response.error || 'Dosya işleme sırasında bir hata oluştu.');
                }
            });
        }
        
        // Dosya listesini güncelle
        function updateFileList() {
            $.ajax({
                url: '/api/files',
                type: 'GET',
                success: function(response) {
                    fileListBody.empty();
                    
                    if (response.files && response.files.length > 0) {
                        fileList.removeClass('d-none');
                        
                        response.files.forEach(function(file, index) {
                            const row = $('<tr>');
                            row.append($('<td>').text(file.name));
                            row.append($('<td>').text(file.type.toUpperCase()));
                            row.append($('<td>').text(file.upload_time));
                            
                            const actionCell = $('<td>');
                            const downloadBtn = $('<a>')
                                .attr('href', '/download/' + index)
                                .addClass('btn btn-sm btn-primary me-2')
                                .text('İndir');
                            
                            actionCell.append(downloadBtn);
                            
                            if (file.is_result) {
                                const viewBtn = $('<button>')
                                    .addClass('btn btn-sm btn-secondary')
                                    .text('Önizle')
                                    .click(function() {
                                        // Önizleme işlemi
                                    });
                                
                                actionCell.append(viewBtn);
                            }
                            
                            row.append(actionCell);
                            fileListBody.append(row);
                        });
                    } else {
                        fileList.addClass('d-none');
                    }
                }
            });
        }
        
        // Sonucu göster
        function showResult(fileIndex, filename) {
            resultSection.removeClass('d-none');
            resultButtons.empty();
            
            const downloadBtn = $('<a>')
                .attr('href', '/download/' + fileIndex)
                .addClass('btn btn-primary')
                .text('Raporu İndir');
            
            resultButtons.append(downloadBtn);
            
            // PDF olarak indir butonu
            const pdfBtn = $('<a>')
                .attr('href', '/convert-to-pdf/' + fileIndex)
                .addClass('btn btn-secondary')
                .text('PDF Olarak İndir');
            
            resultButtons.append(pdfBtn);
        }
        
        // Hata göster
        function showError(message) {
            errorSection.removeClass('d-none');
            errorMessage.text(message);
        }
        
        // İlk yüklemede dosya listesini al
        updateFileList();
    });
</script>
{% endblock %}
